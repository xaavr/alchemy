import os
import subprocess
from celery import shared_task
from django.conf import settings
from .models import Conversion
from django.utils import timezone

@shared_task
def convert_media_task(conversion_id):
    try:
        conversion = Conversion.objects.select_related('original_file').get(id=conversion_id)
        input_path = conversion.original_file.file.path
        output_format = conversion.target_format
        output_basename = os.path.splitext(conversion.original_file.filename)[0]
        output_filename = f"{output_basename}_converted.{output_format}"
        output_path = os.path.join(settings.MEDIA_ROOT, 'converted', output_filename)

        # Make sure the output directory exists
        os.makedirs(os.path.dirname(output_path), exist_ok=True)

        # Run FFmpeg command
        command = [
            'ffmpeg',
            '-i', input_path,
            output_path
        ]
        subprocess.run(command, check=True)

        # Update conversion status
        conversion.result_file.name = os.path.join('converted', output_filename)
        conversion.status = 'done'
        conversion.completed_at = timezone.now()
        conversion.save()

    except Exception as e:
        conversion.status = 'failed'
        conversion.error_message = str(e)
        conversion.save()
        raise
